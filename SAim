-- Получаем настройки из UI или используем дефолтные
local settings = _G.SilentAimSettings or {
    FOV = 100,
    ShowFOVCircle = true,
    TeamCheck = true,
    VisibilityCheck = true
}

local CurrentCamera = workspace.CurrentCamera
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local RunService = game:GetService("RunService")

-- FOV Circle
local fovCircle = nil
if settings.ShowFOVCircle then
    fovCircle = Drawing.new("Circle")
    fovCircle.Color = Color3.fromRGB(255, 255, 255)
    fovCircle.Thickness = 2
    fovCircle.Radius = settings.FOV
    fovCircle.Filled = false
    fovCircle.Transparency = 0.7
    fovCircle.Visible = true
    fovCircle.NumSides = 60
end

-- Обновление FOV круга
local fovConnection
if fovCircle then
    fovConnection = RunService.Heartbeat:Connect(function()
        if _G.SilentAimSettings and _G.SilentAimSettings.ShowFOVCircle then
            fovCircle.Position = Vector2.new(Mouse.X, Mouse.Y)
            fovCircle.Radius = _G.SilentAimSettings.FOV or settings.FOV
            fovCircle.Visible = true
            -- Обновляем настройки в реальном времени
            settings.FOV = _G.SilentAimSettings.FOV or settings.FOV
            settings.ShowFOVCircle = _G.SilentAimSettings.ShowFOVCircle
            settings.TeamCheck = _G.SilentAimSettings.TeamCheck
            settings.VisibilityCheck = _G.SilentAimSettings.VisibilityCheck
        else
            fovCircle.Visible = false
        end
    end)
end

-- Функция поиска ближайшего игрока с FOV проверкой
function ClosestPlayer()
    local MaxDist, Closest = settings.FOV, nil -- Используем FOV как максимальную дистанцию
    
    for I, V in pairs(Players:GetPlayers()) do
        if V == LocalPlayer then continue end
        
        -- Проверка команды
        if settings.TeamCheck and V.Team == LocalPlayer.Team then continue end
        
        if not V.Character then continue end
        local Head = V.Character:FindFirstChild("Head")
        if not Head then continue end
        
        -- Проверка видимости
        if settings.VisibilityCheck then
            local ray = workspace:Raycast(CurrentCamera.CFrame.Position, (Head.Position - CurrentCamera.CFrame.Position).Unit * 1000)
            if ray and ray.Instance and not ray.Instance:IsDescendantOf(V.Character) then
                continue
            end
        end
        
        local Pos, Vis = CurrentCamera:WorldToScreenPoint(Head.Position)
        if not Vis then continue end
        
        local MousePos = Vector2.new(Mouse.X, Mouse.Y)
        local TheirPos = Vector2.new(Pos.X, Pos.Y)
        local Dist = (TheirPos - MousePos).Magnitude
        
        -- Проверяем, что игрок в пределах FOV
        if Dist < MaxDist then
            MaxDist = Dist
            Closest = V
        end
    end
    return Closest
end

-- Сохраняем оригинальные метаметоды
local MT = getrawmetatable(game)
local OldNC = MT.__namecall
local OldIDX = MT.__index

setreadonly(MT, false)

MT.__namecall = newcclosure(function(self, ...)
    local Args, Method = {...}, getnamecallmethod()
    if Method == "FindPartOnRayWithIgnoreList" and not checkcaller() then
        local CP = ClosestPlayer()
        if CP and CP.Character and CP.Character:FindFirstChild("Head") then
            Args[1] = Ray.new(CurrentCamera.CFrame.Position, (CP.Character.Head.Position - CurrentCamera.CFrame.Position).Unit * 1000)
            return OldNC(self, unpack(Args))
        end
    end
    return OldNC(self, ...)
end)

MT.__index = newcclosure(function(self, K)
    if K == "Clips" then
        return workspace.Map or workspace:FindFirstChild("Map")
    end
    return OldIDX(self, K)
end)

setreadonly(MT, true)

-- Функция очистки (вызывается при выключении)
local function cleanup()
    if fovCircle then
        fovCircle:Remove()
        fovCircle = nil
    end
    if fovConnection then
        fovConnection:Disconnect()
        fovConnection = nil
    end
end

-- Очистка при выходе игрока
Players.PlayerRemoving:Connect(function(player)
    if player == LocalPlayer then
        cleanup()
    end
end)

print("Silent Aim загружен с настройками:")
print("FOV:", settings.FOV)
print("FOV Circle:", settings.ShowFOVCircle)
print("Team Check:", settings.TeamCheck)
print("Visibility Check:", settings.VisibilityCheck)
